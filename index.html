<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Icicles</title>
  <meta name="description" content="simulation of dripping christmas lights">
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body style="background: black; font-family: sans-serif; color: white;">
  <div style="display: flex">
    <svg width="280" height="360">
      <g id="icicle-0">
        <circle cx="10" cy="10" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="40" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="70" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="100" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="130" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="160" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="190" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="220" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="250" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="280" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="310" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="10" cy="340" r="8" style="fill:darkslategrey;"></circle>
      </g>
      <g id="icicle-1"> 
        <circle cx="70" cy="10" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="40" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="70" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="100" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="130" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="160" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="190" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="220" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="250" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="280" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="310" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="70" cy="340" r="8" style="fill:darkslategrey;"></circle>
      </g>
      <g id="icicle-2">
        <circle cx="130" cy="10" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="40" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="70" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="100" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="130" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="160" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="190" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="220" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="250" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="280" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="310" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="130" cy="340" r="8" style="fill:darkslategrey;"></circle>
      </g>
      <g id="icicle-3">
        <circle cx="190" cy="10" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="40" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="70" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="100" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="130" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="160" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="190" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="220" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="250" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="280" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="310" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="190" cy="340" r="8" style="fill:darkslategrey;"></circle>
      </g>
      <g id="icicle-4">
        <circle cx="250" cy="10" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="40" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="70" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="100" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="130" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="160" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="190" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="220" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="250" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="280" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="310" r="8" style="fill:darkslategrey;"></circle>
        <circle cx="250" cy="340" r="8" style="fill:darkslategrey;"></circle>
      </g>
    </svg>
    <div style="flex: right;">
      <div>
      <formgroup>
        <label>Rates</label>
        <label>1: <input id="rate-0" type="text" /></label>
        <label>2: <input id="rate-1" type="text" /></label>
        <label>3: <input id="rate-2" type="text" /></label>
        <label>4: <input id="rate-3" type="text" /></label>
        <label>5: <input id="rate-4" type="text" /></label>
        <input type="button" onclick="setRates();" value="Set" />
      </div>
      <p>Time: <span id="time"></span></p>
      <div>
        Positions:
        <ul style="font-family: monospace; text-align: right; list-style-type: none;" id="positions"></ul>
      </div>
      <div>
        <label>Jump: <input id="jump" type="text" /> <input type="button" onclick="jump();" value="Go" /></label>
      </div>
      <div>
        <label>
          Auto:
          Speed <input id="autoSpeed" type="text" />
          <input type="button" onclick="auto(true);" value="Start" />
          <input type="button" onclick="auto(false);" value="Stop" />
        </label>
      </div>
      <p>Synced ranges:</p>
      <ul id="ranges">
      </ul>
    </div>
  </div>


  <script lang="javascript">
    let time = 0;
    
    let synced = true;
    let syncStart = 0;
    let syncEnd = 0;
    let syncedRanges = [];
    let rates = [1,1.01,1.06,1.03,1.02];
    let autoSpeed = 10;

    rates.forEach((e, i) => document.querySelector(`#rate-${i}`).value = e);

    const setRates = () => {
      const newRates = rates.map((e,i) => parseFloat(document.querySelector(`#rate-${i}`).value))
      if (newRates.some(it => isNaN(it))) {
        return;
      }

      rates = newRates;
      syncedRanges = [];
      time = 0;
      reset();
    }

    const jump = () => {
      time = parseInt(document.querySelector("#jump").value || 0);
      reset();
    }

    const reset = () => {
      synced = false;
      syncStart = undefined;
      syncEnd = undefined;
      render(calculatePositions());
    }

    let req;
    const step = () => {
      let results;
      for (let i = 0; i<autoSpeed; i++) {
        time++;
        results = calculatePositions();
      }
      render(results);
      req = window.requestAnimationFrame(step);
    }

    const auto = (start) => {
      if (start) {
        autoSpeed = parseInt(document.querySelector("#autoSpeed").value) || 10
        if (req) {
          return;
        }
        req = window.requestAnimationFrame(step);
      } else {
        if (!req) {
          return;
        }
        window.cancelAnimationFrame(req);
        req = null;
      }
    }

    const calculatePositions = () => {
      const positions = rates
        .map(rate => (time * rate) % 18);

      const offsets = positions
        .map(it => Math.floor(it));

      if (offsets.every((e, i, a) => e === a[0])) {
        if (syncedRanges.some(r => r[0] <= time && r[1] >= time)) {
          // do nothing
        } else {
          if (synced) {
            if (syncStart > time) {
              syncStart = time;
            } else {
              syncEnd = time;
            }
          } else {
            synced = true;
            syncStart = time;
            syncEnd = time;
          }
        }
      } else {
        if (synced) {
          syncedRanges.push([syncStart, syncEnd])
          synced = false;
        }
      }

      return { positions, offsets };
    }

    const render = ({ positions, offsets }) => {      
      const join = d3.select("#ranges")
          .selectAll("li")
          .data(syncedRanges);
      
      join.enter()
          .append("li")
          .text(function(d, i) { return `${d[0]} â€“ ${d[1]}`; })
          .on("click", function(e, d) { time = d[0]; reset(); })
      
      join.exit()
          .remove();

      d3.select("#time")
        .text(time)

      d3.select("#positions")
        .selectAll("li")
        .data(positions)
        .text(d => d.toFixed(4))
        .enter()
        .append("li")
        .text(d => d.toFixed(4));

      offsets.forEach((offset, i) => {
        d3.select(`#icicle-${i}`)
          .selectAll("circle")
          .style("fill", function(d, i) {
            const start = (offset);
            const end = (offset + 5);

            return (i >= start && i <= end) || (i <= end - 18)
              ? 'white'
              : 'darkslategrey'
          });
      });
    }

    document.addEventListener('keydown', (event) => {
      switch (event.key) {
        case 'ArrowRight': {
          time++;
          render(calculatePositions());
          break;
        }
        case 'ArrowLeft': {
          time--;
          render(calculatePositions());
          break;
        }
      }
    }, false);

    render(calculatePositions());
  </script>

</body>

</html>
